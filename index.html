<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Deudas con Calendario</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .calendar-day {
            position: relative;
            transition: transform 0.2s;
        }
        .calendar-day:hover {
            transform: scale(1.05);
            z-index: 10;
        }
        .tooltip {
            visibility: hidden;
            width: max-content;
            background-color: #111827; /* gray-900 */
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 20;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            white-space: pre-wrap;
            border: 1px solid #374151; /* gray-700 */
        }
        .calendar-day:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .card-alert {
            border-left: 4px solid #f59e0b; /* Amber 500 */
            background-color: #43382c; 
        }
        .card-due-soon {
            border-left: 4px solid #ef4444; /* Red 500 */
            background-color: #452b2b;
        }
        .hidden-field, #edit-modal.hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <header class="mb-8">
            <h1 class="text-4xl font-bold text-white">Panel de Control Financiero</h1>
            <p class="text-gray-400 mt-2">Gestiona tus gastos con un calendario y gráficos interactivos.</p>
        </header>

        <!-- Google Sheets Integration -->
        <div class="mb-8 bg-gray-800 p-4 rounded-2xl shadow-lg border border-gray-700">
            <h2 class="text-lg font-semibold text-white mb-2">Conexión con Google Sheets</h2>
            <div class="flex items-center space-x-2">
                <input type="url" id="google-script-url" placeholder="Pega la URL de tu Apps Script aquí" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white focus:ring-blue-500 focus:border-blue-500">
                <button id="save-script-url" class="px-4 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700">Guardar</button>
            </div>
            <p id="url-status" class="text-xs text-gray-400 mt-2"></p>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard-container" class="mb-8 bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700">
            <h2 class="text-xl font-semibold text-gray-200 mb-4">Resumen de Gastos por Categoría (Mes Actual)</h2>
            <div class="h-64 flex items-center justify-center">
                <canvas id="category-chart"></canvas>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Form Column -->
            <div class="lg:col-span-1 bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700 h-fit">
                <h2 class="text-xl font-semibold text-white mb-4">Agregar Nuevo Gasto</h2>
                <form id="debt-form" class="space-y-4">
                    <div>
                        <label for="payment-type" class="block text-sm font-medium text-gray-300">Tipo de Gasto</label>
                        <select id="payment-type" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white focus:ring-blue-500 focus:border-blue-500">
                            <option value="loan">Préstamo a Plazos</option>
                            <option value="recurring">Pago Mensual Fijo</option>
                        </select>
                    </div>
                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-300">Descripción</label>
                        <input type="text" id="description" placeholder="Ej: Préstamo de auto" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                     <div>
                        <label for="category" class="block text-sm font-medium text-gray-300">Categoría</label>
                        <select id="category" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white focus:ring-blue-500 focus:border-blue-500">
                            <option>Vivienda</option>
                            <option>Transporte</option>
                            <option>Alimentación</option>
                            <option>Suscripciones</option>
                            <option>Educación</option>
                            <option>Ocio</option>
                            <option>Salud</option>
                            <option>Otro</option>
                        </select>
                    </div>
                    <div id="loan-fields">
                        <div class="mt-4">
                            <label for="amount" class="block text-sm font-medium text-gray-300">Monto Total</label>
                            <input type="number" id="amount" placeholder="Ej: 500000" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="mt-4">
                            <label for="installments" class="block text-sm font-medium text-gray-300">Meses a Pagar</label>
                            <input type="number" id="installments" min="1" placeholder="Ej: 12" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div id="recurring-fields" class="hidden-field">
                         <label for="monthly-amount" class="block text-sm font-medium text-gray-300">Monto Mensual</label>
                         <input type="number" id="monthly-amount" placeholder="Ej: 15000" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="due-date" class="block text-sm font-medium text-gray-300">Fecha de Próximo Vencimiento</label>
                        <input type="date" id="due-date" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <button type="submit" id="add-expense-btn" class="w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg cursor-not-allowed" disabled>
                        Conectando...
                    </button>
                </form>
            </div>

            <!-- Calendar and Debts Column -->
            <div class="lg:col-span-2 space-y-8">
                <div id="calendar-container" class="bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700"></div>
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center space-x-4">
                             <h2 class="text-2xl font-bold text-white">Mis Gastos</h2>
                             <button id="download-csv-btn" title="Descargar como CSV" class="p-2 bg-gray-600 text-gray-200 rounded-full hover:bg-gray-500 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                             </button>
                        </div>
                         <div class="bg-gray-800 p-3 rounded-xl shadow-lg border border-gray-700">
                             <p class="text-sm font-semibold text-gray-300">Total a Pagar este Mes</p>
                             <p class="text-2xl font-bold text-blue-400 text-right" id="monthly-total">$0.00</p>
                         </div>
                    </div>
                    <div id="all-debts" class="space-y-4">
                        <p class="text-gray-400">Aún no has agregado gastos.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-md border border-gray-700">
            <h2 class="text-2xl font-bold text-white mb-6">Editar Gasto</h2>
            <form id="edit-form" class="space-y-4"></form>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // *** NO EDITAR ESTA LÍNEA ***
        const firebaseConfig = {
  apiKey: "AIzaSyCjAcg0Y_jWkH3fps3uMVlHiDrD_Kcb-2g",
  authDomain: "mis-finanzas-personales-dbbad.firebaseapp.com",
  projectId: "mis-finanzas-personales-dbbad",
  storageBucket: "mis-finanzas-personales-dbbad.firebasestorage.app",
  messagingSenderId: "213510148351",
  appId: "1:213510148351:web:e279d8d96a2cbea36c3cca",
  measurementId: "G-QJM26K2FNK"
};


        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-debt-app-calendar';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null;
        let debtsCollectionRef = null;
        let allDebts = [];
        let currentDate = new Date();
        let categoryChart = null;

        const debtForm = document.getElementById('debt-form');
        const allDebtsContainer = document.getElementById('all-debts');
        const monthlyTotalEl = document.getElementById('monthly-total');
        const calendarContainer = document.getElementById('calendar-container');
        const paymentTypeSelect = document.getElementById('payment-type');
        const loanFields = document.getElementById('loan-fields');
        const recurringFields = document.getElementById('recurring-fields');
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const downloadCsvBtn = document.getElementById('download-csv-btn');
        const googleScriptUrlInput = document.getElementById('google-script-url');
        const saveScriptUrlBtn = document.getElementById('save-script-url');
        const urlStatusEl = document.getElementById('url-status');
        const addExpenseBtn = document.getElementById('add-expense-btn');

        const currencyFormatter = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' });

        // --- GOOGLE SHEETS INTEGRATION ---
        function loadAndDisplayScriptUrl() {
            const savedUrl = localStorage.getItem('googleScriptUrl');
            if (savedUrl) {
                googleScriptUrlInput.value = savedUrl;
                urlStatusEl.textContent = 'URL guardada. Los nuevos gastos se enviarán a Google Sheets.';
                urlStatusEl.style.color = '#10b981'; // green-500
            } else {
                 urlStatusEl.textContent = 'Ingresa la URL de tu script para activar la sincronización automática.';
                 urlStatusEl.style.color = '#f59e0b'; // amber-500
            }
        }

        saveScriptUrlBtn.addEventListener('click', () => {
            const url = googleScriptUrlInput.value;
            if (url && url.startsWith('https://script.google.com/macros/s/')) {
                localStorage.setItem('googleScriptUrl', url);
                loadAndDisplayScriptUrl();
            } else {
                alert('Por favor, ingresa una URL de Google Apps Script válida.');
            }
        });
        
        async function sendDataToGoogleSheet(data) {
            const url = localStorage.getItem('googleScriptUrl');
            if (!url) return; // No hay URL, no hacer nada

            // Prepara los datos para el script
            const payload = {
                description: data.description,
                category: data.category,
                paymentType: data.paymentType === 'loan' ? 'Préstamo a Plazos' : 'Pago Mensual Fijo',
                totalAmount: data.totalAmount || null,
                installments: data.installments || null,
                monthlyPayment: data.monthlyPayment,
                nextDueDate: data.nextDueDate.toDate().toISOString()
            };

            try {
                await fetch(url, {
                    method: 'POST',
                    mode: 'no-cors', // Importante para evitar errores de CORS con Apps Script
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            } catch (error) {
                console.error('Error al enviar datos a Google Sheets:', error);
                // Opcional: mostrar una notificación de error al usuario
            }
        }


        paymentTypeSelect.addEventListener('change', (e) => {
            if (e.target.value === 'loan') {
                loanFields.classList.remove('hidden-field');
                recurringFields.classList.add('hidden-field');
            } else {
                loanFields.classList.add('hidden-field');
                recurringFields.classList.remove('hidden-field');
            }
        });

        // --- AUTHENTICATION (ROBUST VERSION) ---
        function attemptSignIn(retries = 3, delay = 1000) {
            signInAnonymously(auth).catch(error => {
                console.error(`Sign-in attempt failed. Retries left: ${retries-1}`, error);
                if (retries > 1) {
                    // Retry with a slightly longer delay
                    setTimeout(() => attemptSignIn(retries - 1, delay * 1.5), delay);
                } else {
                    // All retries failed
                    addExpenseBtn.textContent = 'Error de Conexión';
                    console.error("Could not connect to the database after multiple attempts.", error);
                }
            });
        }

        onAuthStateChanged(auth, user => {
            if (user) {
                // User is signed in.
                userId = user.uid;
                debtsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/debts`);
                listenForDebts();
                loadAndDisplayScriptUrl();
                
                // Enable the form button
                addExpenseBtn.disabled = false;
                addExpenseBtn.textContent = 'Agregar Gasto';
                addExpenseBtn.classList.remove('bg-gray-500', 'cursor-not-allowed');
                addExpenseBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');

            } else {
                // User is signed out. Try to sign in.
                attemptSignIn();
            }
        });

        debtForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) { 
                alert("Error: Usuario no autenticado. Por favor, espera un momento y vuelve a intentarlo."); 
                return; 
            }

            const paymentType = paymentTypeSelect.value;
            const description = document.getElementById('description').value;
            const category = document.getElementById('category').value;
            const dueDateStr = document.getElementById('due-date').value;
            
            const [year, month, day] = dueDateStr.split('-');
            const nextDueDate = Timestamp.fromDate(new Date(year, month - 1, day));

            let debtData = { description, category, nextDueDate, paymentType, createdAt: new Date() };

            if (paymentType === 'loan') {
                const totalAmount = parseFloat(document.getElementById('amount').value);
                const installments = parseInt(document.getElementById('installments').value);
                if (isNaN(totalAmount) || isNaN(installments) || installments <= 0) {
                    alert("Para préstamos, el monto total y los meses deben ser números válidos."); return;
                }
                const monthlyPayment = totalAmount / installments;
                debtData = { ...debtData, totalAmount, installments, remainingInstallments: installments, monthlyPayment, nextPaymentAmount: monthlyPayment };
            } else {
                const monthlyAmount = parseFloat(document.getElementById('monthly-amount').value);
                 if (isNaN(monthlyAmount) || monthlyAmount <= 0) {
                    alert("Para pagos fijos, el monto mensual debe ser un número válido."); return;
                }
                debtData = { ...debtData, monthlyPayment: monthlyAmount, nextPaymentAmount: monthlyAmount };
            }

            await addDoc(debtsCollectionRef, debtData);
            await sendDataToGoogleSheet(debtData); // Enviar datos a Google Sheets
            debtForm.reset();
            paymentTypeSelect.dispatchEvent(new Event('change'));
        });

        function listenForDebts() {
            if (!debtsCollectionRef) return;
            const q = query(debtsCollectionRef);
            onSnapshot(q, (snapshot) => {
                allDebts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll(allDebts);
            });
        }
        
        function renderAll(debts) {
            renderDebtList(debts);
            renderCalendar(currentDate.getFullYear(), currentDate.getMonth(), debts);
            renderDashboard(debts);
        }

        function renderDebtList(debts) {
            allDebtsContainer.innerHTML = '';
            let totalMonthlyPayment = 0;

            if (debts.length === 0) {
                allDebtsContainer.innerHTML = '<p class="text-gray-400">Aún no has agregado gastos.</p>';
            } else {
                debts.sort((a, b) => a.nextDueDate.toDate() - b.nextDueDate.toDate()).forEach(debt => {
                    const debtCard = createDebtCard(debt);
                    allDebtsContainer.appendChild(debtCard);
                    totalMonthlyPayment += debt.nextPaymentAmount;
                });
            }
            monthlyTotalEl.textContent = currencyFormatter.format(totalMonthlyPayment);
        }

        function createDebtCard(debt) {
            const card = document.createElement('div');
            card.className = 'bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700';
            
            const nextDueDate = debt.nextDueDate.toDate();
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const diffDays = Math.ceil((nextDueDate - today) / (1000 * 60 * 60 * 24));
            let isDueSoon = diffDays >= 0 && diffDays <= 7;

            if (isDueSoon) card.classList.add('card-due-soon');
            else if (debt.paymentType === 'loan' && debt.remainingInstallments <= 3 && debt.remainingInstallments > 0) card.classList.add('card-alert');

            const dateFormatter = new Intl.DateTimeFormat('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
            let cardHeader, cardBody;

            if (debt.paymentType === 'loan') {
                cardHeader = `<p class="text-sm text-gray-400">Quedan ${debt.remainingInstallments} de ${debt.installments} cuotas.</p>`;
                cardBody = `<div class="flex justify-between items-center"><span class="text-sm font-medium text-gray-400">Saldo restante aprox:</span><span class="font-semibold text-gray-200">${currencyFormatter.format(debt.nextPaymentAmount * debt.remainingInstallments)}</span></div>`;
            } else {
                cardHeader = `<p class="text-sm text-green-400 font-medium">Pago Mensual Fijo</p>`;
                cardBody = ``;
            }

            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="font-bold text-lg text-white">${debt.description}</h3>
                        <p class="text-xs text-gray-400 font-semibold uppercase tracking-wider">${debt.category || 'Sin Categoría'}</p>
                        ${cardHeader}
                    </div>
                    <div>
                        ${isDueSoon ? `<span class="text-xs font-semibold bg-red-500 text-white px-2 py-1 rounded-full">Vence pronto</span>` : ''}
                        ${!isDueSoon && debt.paymentType === 'loan' && debt.remainingInstallments <= 3 && debt.remainingInstallments > 0 ? `<span class="text-xs font-semibold bg-yellow-500 text-yellow-900 px-2 py-1 rounded-full">¡Últimas cuotas!</span>` : ''}
                    </div>
                </div>
                <div class="mt-4 space-y-3">
                     <div class="flex justify-between items-center"><span class="text-sm font-medium text-gray-400">Próximo vencimiento:</span><span class="font-semibold text-gray-200">${dateFormatter.format(nextDueDate)}</span></div>
                     ${cardBody}
                </div>
                <div class="mt-4 pt-4 border-t border-gray-700">
                    <label class="block text-sm font-medium text-gray-300 mb-1">Monto a Pagar:</label>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="next-payment-${debt.id}" value="${debt.nextPaymentAmount.toFixed(2)}" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white">
                        <button data-id="${debt.id}" class="update-payment-btn px-3 py-2 bg-gray-600 text-gray-200 text-sm font-semibold rounded-md hover:bg-gray-500">Actualizar</button>
                    </div>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button class="pay-btn w-full bg-green-600 text-white font-bold py-2 rounded-lg hover:bg-green-700">Marcar Pagada</button>
                    <button class="edit-btn bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-700">Editar</button>
                    <button class="delete-btn bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Eliminar</button>
                </div>`;

            card.querySelector('.update-payment-btn').addEventListener('click', () => updatePaymentAmount(debt.id));
            card.querySelector('.pay-btn').addEventListener('click', () => markAsPaid(debt));
            card.querySelector('.edit-btn').addEventListener('click', () => openEditModal(debt));
            card.querySelector('.delete-btn').addEventListener('click', () => deleteDebt(debt.id));
            
            return card;
        }

        async function updatePaymentAmount(debtId) {
            const newAmount = parseFloat(document.getElementById(`next-payment-${debtId}`).value);
            if (isNaN(newAmount) || newAmount < 0) { alert("Monto inválido."); return; }
            await updateDoc(doc(db, debtsCollectionRef.path, debtId), { nextPaymentAmount: newAmount });
        }

        async function markAsPaid(debt) {
            const debtRef = doc(db, debtsCollectionRef.path, debt.id);
            if (debt.paymentType === 'loan' && debt.remainingInstallments <= 1) {
                await deleteDoc(debtRef);
            } else {
                const newDueDate = new Date(debt.nextDueDate.toDate().setMonth(debt.nextDueDate.toDate().getMonth() + 1));
                const updates = { nextDueDate: Timestamp.fromDate(newDueDate) };
                if (debt.paymentType === 'loan') {
                    updates.remainingInstallments = debt.remainingInstallments - 1;
                    updates.nextPaymentAmount = debt.monthlyPayment;
                }
                await updateDoc(debtRef, updates);
            }
        }

        async function deleteDebt(debtId) {
            await deleteDoc(doc(db, debtsCollectionRef.path, debtId));
        }

        // --- EDIT MODAL ---
        function openEditModal(debt) {
            const isLoan = debt.paymentType === 'loan';
            editForm.innerHTML = `
                <input type="hidden" id="edit-id" value="${debt.id}">
                <div>
                    <label for="edit-description" class="block text-sm font-medium text-gray-300">Descripción</label>
                    <input type="text" id="edit-description" value="${debt.description}" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white" required>
                </div>
                <div>
                    <label for="edit-category" class="block text-sm font-medium text-gray-300">Categoría</label>
                    <select id="edit-category" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white">
                        <option>Vivienda</option><option>Transporte</option><option>Alimentación</option><option>Suscripciones</option><option>Educación</option><option>Ocio</option><option>Salud</option><option>Otro</option>
                    </select>
                </div>
                <div class="${isLoan ? '' : 'hidden-field'}">
                    <label for="edit-amount" class="block text-sm font-medium text-gray-300">Monto Total</label>
                    <input type="number" id="edit-amount" value="${debt.totalAmount || ''}" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white">
                </div>
                <div class="mt-4 ${isLoan ? '' : 'hidden-field'}">
                    <label for="edit-installments" class="block text-sm font-medium text-gray-300">Meses a Pagar</label>
                    <input type="number" id="edit-installments" value="${debt.installments || ''}" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white">
                </div>
                <div class="${!isLoan ? '' : 'hidden-field'}">
                    <label for="edit-monthly-amount" class="block text-sm font-medium text-gray-300">Monto Mensual</label>
                    <input type="number" id="edit-monthly-amount" value="${debt.monthlyPayment || ''}" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white">
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancel-edit" class="px-4 py-2 bg-gray-600 text-gray-200 rounded-lg hover:bg-gray-500">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Guardar Cambios</button>
                </div>
            `;
            document.getElementById('edit-category').value = debt.category;
            editModal.classList.remove('hidden');
            document.getElementById('cancel-edit').addEventListener('click', () => editModal.classList.add('hidden'));
        }

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const debtRef = doc(db, debtsCollectionRef.path, id);
            
            const originalDebt = allDebts.find(d => d.id === id);
            const isLoan = originalDebt.paymentType === 'loan';

            const updates = {
                description: document.getElementById('edit-description').value,
                category: document.getElementById('edit-category').value,
            };

            if(isLoan) {
                updates.totalAmount = parseFloat(document.getElementById('edit-amount').value);
                updates.installments = parseInt(document.getElementById('edit-installments').value);
            } else {
                updates.monthlyPayment = parseFloat(document.getElementById('edit-monthly-amount').value);
                updates.nextPaymentAmount = updates.monthlyPayment;
            }

            await updateDoc(debtRef, updates);
            editModal.classList.add('hidden');
        });

        // --- DASHBOARD ---
        function renderDashboard(debts) {
            const ctx = document.getElementById('category-chart').getContext('2d');
            const categoryTotals = debts.reduce((acc, debt) => {
                const category = debt.category || 'Sin Categoría';
                acc[category] = (acc[category] || 0) + debt.nextPaymentAmount;
                return acc;
            }, {});

            if (categoryChart) {
                categoryChart.destroy();
            }

            if(Object.keys(categoryTotals).length === 0) {
                 ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                 ctx.font = "16px Inter";
                 ctx.fillStyle = "#6b7280"; // gray-500
                 ctx.textAlign = "center";
                 ctx.fillText("Agrega un gasto para ver el resumen.", ctx.canvas.width / 2, ctx.canvas.height / 2);
                 return;
            }
            
            Chart.defaults.color = '#d1d5db'; // gray-300

            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryTotals),
                    datasets: [{
                        data: Object.values(categoryTotals),
                        backgroundColor: ['#2563eb', '#059669', '#ea580c', '#dc2626', '#7c3aed', '#db2777', '#f59e0b', '#6b7280'],
                        borderColor: '#1f2937', // gray-800
                        borderWidth: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#d1d5db' // gray-300
                            }
                        }
                    }
                }
            });
        }

        // --- CALENDAR ---
        const chileanHolidays = {
            "2024": [
                { date: "2024-01-01", name: "Año Nuevo" }, { date: "2024-03-29", name: "Viernes Santo" }, { date: "2024-03-30", name: "Sábado Santo" },
                { date: "2024-05-01", name: "Día del Trabajo" }, { date: "2024-05-21", name: "Día de las Glorias Navales" }, { date: "2024-06-20", name: "Día Nacional de los Pueblos Indígenas" },
                { date: "2024-06-29", name: "San Pedro y San Pablo" }, { date: "2024-07-16", name: "Día de la Virgen del Carmen" }, { date: "2024-08-15", name: "Asunción de la Virgen" },
                { date: "2024-09-18", name: "Independencia Nacional" }, { date: "2024-09-19", name: "Día de las Glorias del Ejército" }, { date: "2024-09-20", name: "Fiestas Patrias" },
                { date: "2024-10-12", name: "Encuentro de Dos Mundos" }, { date: "2024-10-31", name: "Día de las Iglesias Evangélicas" }, { date: "2024-11-01", name: "Día de Todos los Santos" },
                { date: "2024-12-08", name: "Inmaculada Concepción" }, { date: "2024-12-25", name: "Navidad" }
            ],
            "2025": [
                { date: "2025-01-01", name: "Año Nuevo" }, { date: "2025-04-18", name: "Viernes Santo" }, { date: "2025-04-19", name: "Sábado Santo" },
                { date: "2025-05-01", name: "Día del Trabajo" }, { date: "2025-05-21", name: "Día de las Glorias Navales" }, { date: "2025-06-20", name: "Día Nacional de los Pueblos Indígenas" },
                { date: "2025-06-29", name: "San Pedro y San Pablo" }, { date: "2025-07-16", name: "Día de la Virgen del Carmen" }, { date: "2025-08-15", name: "Asunción de la Virgen" },
                { date: "2025-09-18", name: "Independencia Nacional" }, { date: "2025-09-19", name: "Día de las Glorias del Ejército" }, { date: "2025-10-12", name: "Encuentro de Dos Mundos" },
                { date: "2025-10-31", name: "Día de las Iglesias Evangélicas" }, { date: "2025-11-01", name: "Día de Todos los Santos" }, { date: "2025-12-08", name: "Inmaculada Concepción" },
                { date: "2025-12-25", name: "Navidad" }
            ],
            "2026": [
                { date: "2026-01-01", name: "Año Nuevo" }, { date: "2026-04-03", name: "Viernes Santo" }, { date: "2026-04-04", name: "Sábado Santo" },
                { date: "2026-05-01", name: "Día del Trabajo" }, { date: "2026-05-21", name: "Día de las Glorias Navales" }, { date: "2026-06-20", name: "Día Nacional de los Pueblos Indígenas" },
                { date: "2026-06-29", name: "San Pedro y San Pablo" }, { date: "2026-07-16", name: "Día de la Virgen del Carmen" }, { date: "2026-08-15", name: "Asunción de la Virgen" },
                { date: "2026-09-18", name: "Independencia Nacional" }, { date: "2026-09-19", name: "Día de las Glorias del Ejército" }, { date: "2026-10-12", name: "Encuentro de Dos Mundos" },
                { date: "2026-10-31", name: "Día de las Iglesias Evangélicas" }, { date: "2026-11-01", name: "Día de Todos los Santos" }, { date: "2026-12-08", name: "Inmaculada Concepción" },
                { date: "2026-12-25", name: "Navidad" }
            ]
        };

        function getHolidays(year) { return chileanHolidays[year] || []; }

        function renderCalendar(year, month, debts) {
            const holidays = getHolidays(year);
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const dayNames = ["Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom"];
            const firstDay = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startingDay = (firstDay.getDay() + 6) % 7; // Lunes como primer día

            let html = `<div class="flex justify-between items-center mb-4"><button id="prev-month" class="p-2 rounded-full hover:bg-gray-700">&lt;</button><h3 class="text-xl font-bold text-white">${monthNames[month]} ${year}</h3><button id="next-month" class="p-2 rounded-full hover:bg-gray-700">&gt;</button></div><div class="grid grid-cols-7 gap-1 text-center text-sm">`;
            dayNames.forEach(day => html += `<div class="font-semibold text-gray-400">${day}</div>`);
            for (let i = 0; i < startingDay; i++) html += `<div></div>`;

            for (let day = 1; day <= daysInMonth; day++) {
                const loopDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayOfWeek = new Date(year, month, day).getDay();
                const holidayInfo = holidays.find(h => h.date === loopDateStr);
                const isHoliday = !!holidayInfo;
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const debtsOnThisDay = debts.filter(d => { const dueDate = d.nextDueDate.toDate(); return dueDate.getFullYear() === year && dueDate.getMonth() === month && dueDate.getDate() === day; });
                const isDueDate = debtsOnThisDay.length > 0;
                
                let dayClass = 'bg-gray-700/50 text-gray-300';
                if (isHoliday) dayClass = 'bg-red-900/50 text-red-300';
                else if (isWeekend) dayClass = 'bg-gray-700/20 text-gray-500';
                if (isDueDate) dayClass = 'bg-orange-500 text-white font-bold';
                
                let tooltipText = isHoliday ? holidayInfo.name : '';
                if(isDueDate) { tooltipText += (tooltipText ? '\n' : '') + 'Vencimientos:\n' + debtsOnThisDay.map(d => `- ${d.description}`).join('\n'); }
                
                html += `<div class="calendar-day h-10 flex items-center justify-center rounded-lg ${dayClass}">${day}${tooltipText ? `<span class="tooltip">${tooltipText}</span>` : ''}</div>`;
            }
            html += `</div>`;
            calendarContainer.innerHTML = html;

            document.getElementById('prev-month').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderAll(allDebts); });
            document.getElementById('next-month').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderAll(allDebts); });
        }
        
        // --- CSV DOWNLOAD ---
        function downloadCSV() {
            if (allDebts.length === 0) {
                alert("No hay datos para descargar.");
                return;
            }

            const headers = [
                "Descripción", "Categoría", "Tipo de Gasto", "Monto Total", 
                "Cuotas Totales", "Cuotas Restantes", "Monto Próxima Cuota", "Fecha Próximo Vencimiento"
            ];

            const formatCSVField = (field) => {
                const str = String(field ?? '');
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    return `"${str.replace(/"/g, '""')}"`;
                }
                return str;
            };

            const rows = allDebts.map(debt => {
                const nextDueDate = debt.nextDueDate.toDate().toLocaleDateString('es-CL');
                const rowData = [
                    debt.description,
                    debt.category,
                    debt.paymentType === 'loan' ? 'Préstamo a Plazos' : 'Pago Mensual Fijo',
                    debt.paymentType === 'loan' ? debt.totalAmount : '',
                    debt.paymentType === 'loan' ? debt.installments : '',
                    debt.paymentType === 'loan' ? debt.remainingInstallments : '',
                    debt.nextPaymentAmount,
                    nextDueDate
                ];
                return rowData.map(formatCSVField).join(',');
            });

            const csvContent = [headers.join(','), ...rows].join('\n');
            const blob = new Blob([`\uFEFF${csvContent}`], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "mis_gastos.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        downloadCsvBtn.addEventListener('click', downloadCSV);

    </script>
</body>
</html>
